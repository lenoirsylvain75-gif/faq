<script>
  // --- Accord√©ons FAQ ---
  document.addEventListener('DOMContentLoaded', function(){
    // Toggle accordions
    document.querySelectorAll('.faq-item header').forEach(header => {
      const item = header.parentElement;
      header.addEventListener('click', () => toggle(item, header));
      header.addEventListener('keydown', e=>{
        if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle(item, header); }
      });
    });
    function toggle(item, header){
      const expanded = header.getAttribute('aria-expanded') === 'true';
      header.setAttribute('aria-expanded', String(!expanded));
      item.toggleAttribute('open');
      const panel = item.querySelector('.faq-panel');
      if(panel){ panel.style.display = item.hasAttribute('open') ? 'block' : 'none'; }
    }

    // --- Simulation LLM ---
    const llmThread = document.getElementById('llm-thread');
    const llmInput  = document.getElementById('llm-input');
    const llmSend   = document.getElementById('llm-send');

    function pushLLM(role, html){
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (role==='user' ? 'user' : 'assistant');
      wrap.innerHTML = '<div class="bubble"></div>';
      wrap.querySelector('.bubble').innerHTML = html;
      llmThread.appendChild(wrap);
      llmThread.scrollTop = llmThread.scrollHeight;
    }

    function streamLLM(){
      const response = `
<b>üí° Mon conseil&nbsp;: Passat eHybrid</b><br><br>
Si je devais choisir un seul mod√®le <b>polyvalent</b> ‚Äî <b>quotidien</b> + <b>trajets plus longs</b>, sans trop sacrifier le confort ou le co√ªt ‚Äî je pencherais pour la <b>Passat eHybrid</b>. Voici pourquoi :
<ul>
  <li><span class="check">‚úì</span><b>Autonomie √©quilibr√©e</b> : bon compromis entre <b>autonomie √©lectrique</b> et <b>autonomie totale</b> (ville + route).</li>
  <li><span class="check">‚úì</span><b>Habitabilit√© & confort</b> : espace g√©n√©reux, <b>coffre pratique</b>, id√©ale pour un usage familial.</li>
  <li><span class="check">‚úì</span><b>Co√ªt d‚Äôusage</b> : souvent plus favorable qu‚Äôun <b>SUV imposant</b> ou un <b>mod√®le tr√®s sportif</b>.</li>
</ul>
<br>
<p>‚öñÔ∏è <b>Si tes besoins sont diff√©rents</b> (performance, famille nombreuse, budget limit√©, usage urbain pur, etc.), un autre mod√®le peut mieux convenir (ex. <b>Golf eHybrid</b> pour la ville, <b>Tiguan</b> pour plus d‚Äôespace).</p>
<p><i>Souhaites-tu faire un essai de ce v√©hicule&nbsp;?</i></p>
`;
      const wrap = document.createElement('div');
      wrap.className = 'msg assistant';
      wrap.innerHTML = '<div class="bubble"><span class="s"></span></div>';
      const s = wrap.querySelector('.s');
      llmThread.appendChild(wrap);
      llmThread.scrollTop = llmThread.scrollHeight;

      // Tokenisation s√ªre : balises compl√®tes + segments texte/espaces
      const rawTokens = response.split(/(<[^>]+>|\n|\s{2,})/g);
      const queue = [];
      rawTokens.forEach(tok => {
        if (!tok) return;
        if (tok.startsWith('<') && tok.endsWith('>')) {
          queue.push(tok); // balise compl√®te
        } else {
          tok.split(/(\s+)/).forEach(t => { if (t) queue.push(t); });
        }
      });

      let i = 0;
      const t = setInterval(() => {
        s.innerHTML += queue[i++] || '';
        llmThread.scrollTop = llmThread.scrollHeight;
        if (i >= queue.length) clearInterval(t);
      }, 40); // ‚Üê vitesse (ms). Diminue pour aller plus vite
    }

    function sendLLM(){
      const q = (llmInput?.value || '').trim();
      if(!q) return;
      // √©chappe le HTML de l'utilisateur pour √©viter d'injecter du code
      pushLLM('user', q.replace(/</g,'&lt;').replace(/>/g,'&gt;'));
      if (llmInput) llmInput.value='';
      streamLLM();
    }

    if (llmSend) llmSend.addEventListener('click', sendLLM);
    if (llmInput) llmInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); sendLLM(); }});
    document.querySelectorAll('.suggestion-llm').forEach(b=> b.addEventListener('click', ()=>{ if (llmInput){ llmInput.value = b.textContent; sendLLM(); } }));
  });
</script>
